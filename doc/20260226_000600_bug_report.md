# Bug Report - Tart Multi-Cluster VM 배포 실패

- 작성일시: 2026-02-26 00:06:00 (KST, GMT+9)
- 작성자: Claude Code (자동 분석)
- 환경: macOS Darwin 24.6.0 / Apple M4 Max / tart 2.31.0

---

## 1. 요약

`setup_massive_infra.sh`, `setup_multi_cluster.sh`, `setup_by_json.sh` 3개 스크립트 모두 동일한 근본 원인으로 인해 **VM이 부팅되지 않는 치명적 버그**가 존재했다.

## 2. 증상

- 9개 VM이 `tart clone`으로 생성은 되지만, 전부 `stopped` 상태로 남음
- `tart list`에서 모든 VM의 상태가 `stopped`
- SSH 접속 불가 (VM이 실행되지 않았으므로 IP 미할당)

## 3. 근본 원인

### BUG-001: 존재하지 않는 `--config` 옵션 사용 (Critical)

| 항목 | 내용 |
|------|------|
| 심각도 | **Critical** - VM 부팅 자체가 불가능 |
| 영향 범위 | 3개 스크립트 전체 |
| 원인 | `tart run --config user-data=...` 옵션이 tart 2.31.0에 존재하지 않음 |

**재현 방법:**
```bash
$ tart run dev-master --config user-data=./cloud-init-configs/dev-master.yaml --no-graphics
Error: Unknown option '--config'
Usage: tart run [<options>] <name>
  See 'tart run --help' for more information.
# Exit code: 64
```

**검증 결과 — `--config` 없이 실행하면 정상 동작:**
```bash
$ tart run dev-master --no-graphics &
$ tart ip dev-master
192.168.65.6    # IP 정상 할당

$ sshpass -p admin ssh admin@192.168.65.6 "hostname && whoami"
ubuntu
admin           # SSH 정상 접속
```

### BUG-002: cloud-init 미지원 기능 의존 (Major)

| 항목 | 내용 |
|------|------|
| 심각도 | **Major** - 사용자/hostname 설정 불가 |
| 영향 범위 | 3개 스크립트 전체 |
| 원인 | tart는 cloud-init을 네이티브로 지원하지 않음 |

`cirruslabs/ubuntu:latest` 이미지의 기본 계정은 `admin:admin`이며, cloud-init YAML을 전달하는 메커니즘이 tart에 존재하지 않는다. 따라서 cloud-init으로 hostname 변경, 사용자 생성을 시도하는 방식은 근본적으로 작동하지 않는다.

### BUG-003: 에러 출력 은폐 (Minor)

| 항목 | 내용 |
|------|------|
| 심각도 | **Minor** - 디버깅 방해 |
| 영향 파일 | `setup_massive_infra.sh:42` |

```bash
nohup tart run "$NAME" --config user-data="$CFG_PATH" --no-graphics > /dev/null 2>&1 &
```

`> /dev/null 2>&1`로 stdout과 stderr를 모두 버리기 때문에 `--config` 에러 메시지가 보이지 않았다. 이로 인해 VM이 실행되지 않는 원인 파악이 어려웠다.

### BUG-004: Race Condition — 파일 삭제 타이밍 (Minor)

| 항목 | 내용 |
|------|------|
| 심각도 | **Minor** - BUG-001로 인해 도달 불가 |
| 영향 파일 | `setup_multi_cluster.sh:38-39`, `setup_by_json.sh:44-47` |

```bash
tart run "$NAME" --config user-data=user-data --no-graphics > /dev/null 2>&1 &
rm user-data   # 백그라운드 프로세스가 읽기 전에 삭제될 수 있음
```

`tart run &`이 백그라운드로 실행되면서 파일을 읽기 전에 `rm user-data`가 먼저 실행될 가능성이 있다. (BUG-001로 인해 실제로는 도달되지 않는 코드 경로)

## 4. 영향받은 파일 (모두 삭제됨)

| 파일 | 버그 |
|------|------|
| `setup_massive_infra.sh` | BUG-001, BUG-002, BUG-003 |
| `setup_multi_cluster.sh` | BUG-001, BUG-002, BUG-004 |
| `setup_by_json.sh` | BUG-001, BUG-002, BUG-004 |
| `vms_config.json` | `setup_by_json.sh` 전용 설정 (삭제) |
| `cloud-init-configs/` | cloud-init 미지원으로 불필요 (삭제) |

## 5. 수정 사항

신규 스크립트 `setup_cluster.sh`로 대체. 주요 변경:

| 기존 방식 | 개선 방식 |
|-----------|-----------|
| `tart run --config user-data=...` | `tart run --no-graphics` (옵션 없이 부팅) |
| cloud-init으로 사용자/hostname 설정 | SSH 접속 후 `hostnamectl`, `useradd`로 프로비저닝 |
| `sleep 60` 고정 대기 | `tart ip` 폴링으로 IP 할당까지 동적 대기 |
| 에러 출력 `/dev/null` 은폐 | `set -euo pipefail` + 단계별 에러 체크 |
| 기존 VM 충돌 시 실패 | `tart stop` + `tart delete`로 사전 정리 |
| `jq | while read` 파이프라인 서브쉘 | `seq` 기반 인덱스 루프로 서브쉘 문제 회피 |

## 6. 재발 방지

- `tart run --help`로 실제 지원 옵션 확인 후 사용
- `set -euo pipefail` 적용으로 에러 즉시 감지
- stderr를 로그 파일로 리다이렉트하여 디버깅 정보 보존
- 외부 도구의 기능 지원 여부를 공식 문서에서 사전 확인
