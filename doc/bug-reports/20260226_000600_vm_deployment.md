# Bug Report — Tart VM 배포(Deployment) 실패

- **작성일시(Timestamp)**: 2026-02-26 00:06:00 KST(Korean Standard Time)
- **환경(Environment)**: macOS Darwin 24.6.0 / Apple M4 Max / tart 2.31.0
- **심각도(Severity)**: Critical — VM(Virtual Machine) 부팅 자체 불가

---

## 요약(Summary)

`setup_massive_infra.sh`, `setup_multi_cluster.sh`, `setup_by_json.sh` 3개 스크립트 모두 동일한 근본 원인으로 **VM이 부팅되지 않는 치명적 버그**가 존재. 모든 스크립트를 삭제하고 `setup_cluster.sh`로 대체.

---

## BUG-001: 존재하지 않는 `--config` 옵션(Option) 사용

| 항목(Field) | 내용(Detail) |
|------|------|
| 타임스탬프(Timestamp) | 2026-02-26 00:06 |
| 심각도(Severity) | **Critical** — VM 부팅 자체 불가 |
| 카테고리(Category) | CLI(Command Line Interface) |
| 영향 범위(Impact) | 3개 스크립트 전체 |

### 증상(Symptom)
```
$ tart run dev-master --config user-data=./cloud-init-configs/dev-master.yaml --no-graphics
Error: Unknown option '--config'
Usage: tart run [<options>] <name>
  See 'tart run --help' for more information.
# Exit code: 64
```

9개 VM이 `tart clone`으로 생성은 되지만, 전부 `stopped` 상태로 남음.

### 원인(Root Cause)
`tart run --config user-data=...` 옵션이 tart 2.31.0에 존재하지 않음.

### 해결(Fix)
```bash
# Before
tart run "$NAME" --config user-data="$CFG_PATH" --no-graphics > /dev/null 2>&1 &

# After
tart run "$vm_name" --no-graphics --net-softnet-allow=0.0.0.0/0 &
```

### 교훈(Lesson)
외부 CLI(Command Line Interface) 도구의 실제 지원 옵션은 `--help`로 확인 후 사용. 공식 문서와 실제 버전의 차이를 사전 검증.

---

## BUG-002: cloud-init 미지원 기능 의존

| 항목(Field) | 내용(Detail) |
|------|------|
| 타임스탬프(Timestamp) | 2026-02-26 00:06 |
| 심각도(Severity) | **Major** — 사용자/hostname 설정 불가 |
| 카테고리(Category) | VM 프로비저닝(Provisioning) |

### 증상(Symptom)
cloud-init YAML(YAML Ain't Markup Language)을 전달하는 메커니즘이 tart에 존재하지 않아, hostname 변경/사용자 생성 시도가 전부 실패.

### 원인(Root Cause)
Tart는 cloud-init을 네이티브(Native)로 지원하지 않음. `cirruslabs/ubuntu:latest` 이미지의 기본 계정은 `admin:admin`.

### 해결(Fix)
cloud-init 대신 SSH(Secure Shell) 접속 후 `hostnamectl`, `useradd`로 프로비저닝(Provisioning).

### 교훈(Lesson)
플랫폼의 기능 지원 여부를 공식 문서에서 사전 확인. cloud-init은 클라우드 환경 전용이며 로컬 VM 런타임(Runtime)에서는 미지원이 일반적.

---

## BUG-003: 에러(Error) 출력 은폐

| 항목(Field) | 내용(Detail) |
|------|------|
| 타임스탬프(Timestamp) | 2026-02-26 00:06 |
| 심각도(Severity) | **Minor** — 디버깅(Debugging) 방해 |
| 카테고리(Category) | 스크립트(Script) |

### 증상(Symptom)
`nohup ... > /dev/null 2>&1`로 stdout과 stderr를 모두 버려, `--config` 에러 메시지가 보이지 않음.

### 해결(Fix)
`set -euo pipefail` 적용 + 단계별 에러(Error) 체크. stderr를 로그(Log) 파일로 리다이렉트(Redirect).

---

## BUG-004: 레이스 컨디션(Race Condition) — 파일 삭제 타이밍

| 항목(Field) | 내용(Detail) |
|------|------|
| 타임스탬프(Timestamp) | 2026-02-26 00:06 |
| 심각도(Severity) | **Minor** — BUG-001로 인해 도달 불가 |
| 카테고리(Category) | 스크립트(Script) |

### 증상(Symptom)
```bash
tart run "$NAME" --config user-data=user-data --no-graphics > /dev/null 2>&1 &
rm user-data   # 백그라운드 프로세스(Background Process)가 읽기 전에 삭제될 수 있음
```

### 해결(Fix)
파일 의존 방식 제거. SSH 기반 프로비저닝(Provisioning)으로 전환.

---

## 수정 결과(Resolution Summary)

| 기존 방식(Before) | 개선 방식(After) |
|-----------|-----------|
| `tart run --config user-data=...` | `tart run --no-graphics` (옵션 없이 부팅) |
| cloud-init으로 사용자/hostname 설정 | SSH 접속 후 `hostnamectl`, `useradd`로 프로비저닝 |
| `sleep 60` 고정 대기 | `tart ip` 폴링(Polling)으로 IP(Internet Protocol) 할당까지 동적 대기 |
| 에러 출력 `/dev/null` 은폐 | `set -euo pipefail` + 단계별 에러 체크 |

**영향받은 파일(Affected Files)** — 모두 삭제(Deleted):
- `setup_massive_infra.sh`, `setup_multi_cluster.sh`, `setup_by_json.sh`
- `vms_config.json`, `cloud-init-configs/`
